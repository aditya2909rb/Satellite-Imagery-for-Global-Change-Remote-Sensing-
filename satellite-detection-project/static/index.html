<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ∞Ô∏è Satellite Fire Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #ff4444;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
            --info: #17a2b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .navbar {
            background: linear-gradient(90deg, #ff4444 0%, #ff6666 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-size: 1.8rem;
            font-weight: bold;
            color: white !important;
        }

        .container-main {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1.5rem;
            font-weight: 600;
            border: none;
        }

        .card-body {
            padding: 1.5rem;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 2rem;
        }

        .nav-tabs .nav-link {
            color: #666;
            border: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%);
            color: white;
            border: none;
        }

        .nav-tabs .nav-link:hover {
            color: #ff4444;
            border-bottom: 3px solid #ff4444;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%);
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,68,68,0.4);
            color: white;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .fire-icon {
            color: #ff4444;
            margin-right: 0.5rem;
        }

        .alert-box {
            background: white;
            border-left: 5px solid #ff4444;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .alert-high {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .alert-medium {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .alert-low {
            border-left-color: #17a2b8;
            background: #f0f8fb;
        }

        .confidence-bar {
            background: linear-gradient(90deg, #ff4444 0%, #28a745 100%);
            height: 25px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #ddd;
            padding: 0.7rem;
            transition: border-color 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: #ff4444;
            box-shadow: 0 0 10px rgba(255,68,68,0.2);
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge-fire {
            background: #ff4444;
            color: white;
        }

        .badge-smoke {
            background: #ffc107;
            color: #333;
        }

        .badge-dust {
            background: #8b7500;
            color: white;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 1rem 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .detection-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .table thead {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%);
            color: white;
        }

        .table tbody tr {
            transition: background 0.3s;
        }

        .table tbody tr:hover {
            background: #f0f0f0;
        }

        .progress {
            height: 25px;
            border-radius: 5px;
        }

        .export-btn {
            background: #28a745;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 0.5rem;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .email-config {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        footer {
            background: rgba(0,0,0,0.1);
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
        }

        @media (max-width: 768px) {
            .container-main {
                padding: 1rem;
            }
            
            .stat-box {
                margin-bottom: 1rem;
            }
            
            .card-header {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-satellite"></i> üî• Satellite Fire Detection Dashboard
            </span>
            <span style="color: white;">Real-time detection from NASA satellites</span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-main">
        <!-- Status Messages -->
        <div class="success-msg" id="successMsg"></div>
        <div class="error-msg" id="errorMsg"></div>

        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-box">
                    <i class="fas fa-fire fire-icon" style="font-size: 2rem;"></i>
                    <div class="stat-number" id="totalFires">0</div>
                    <div class="stat-label">Total Fires Detected</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <i class="fas fa-cloud" style="font-size: 2rem; color: #ffc107;"></i>
                    <div class="stat-number" id="avgConfidence">0%</div>
                    <div class="stat-label">Average Confidence</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <i class="fas fa-envelope" style="font-size: 2rem; color: #17a2b8;"></i>
                    <div class="stat-number" id="alertsSent">0</div>
                    <div class="stat-label">Alerts Sent</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <i class="fas fa-power-output" style="font-size: 2rem; color: #ff6666;"></i>
                    <div class="stat-number" id="totalPower">0 MW</div>
                    <div class="stat-label">Thermal Power</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
                    <i class="fas fa-chart-pie"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#history" data-bs-toggle="tab">
                    <i class="fas fa-history"></i> History
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#export" data-bs-toggle="tab">
                    <i class="fas fa-download"></i> Export
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#alerts" data-bs-toggle="tab">
                    <i class="fas fa-bell"></i> Email Alerts
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-map"></i> Detection Map</span>
                        <button class="btn btn-sm btn-primary" onclick="autoScanGlobalFires()">
                            <i class="fas fa-sync-alt"></i> Refresh Global Scan
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                            <i class="fas fa-circle" style="color: red;"></i> High Confidence (>90%) |
                            <i class="fas fa-circle" style="color: orange;"></i> Medium Confidence (70-90%) |
                            <i class="fas fa-circle" style="color: yellow;"></i> Low Confidence (<70%)
                        </p>
                        <div id="dataSourceInfo" style="margin-top: 0.5rem; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem;">
                            <strong>Data Source:</strong> <span id="dataSourceLabel">Fetching NASA FIRMS data...</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list"></i> Recent Detections
                    </div>
                    <div class="card-body">
                        <div id="recentDetections" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted">No detections yet. Run a detection to see results here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-pane fade" id="history">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history"></i> Historical Data
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary" onclick="loadHistory()">
                                <i class="fas fa-refresh"></i> Load History (Last 24 Hours)
                            </button>
                            <button type="button" class="btn btn-primary" onclick="loadHistory(7)">
                                <i class="fas fa-refresh"></i> Load History (Last 7 Days)
                            </button>
                            <button type="button" class="btn btn-primary" onclick="loadHistory(30)">
                                <i class="fas fa-refresh"></i> Load History (Last 30 Days)
                            </button>
                        </div>

                        <div id="historyResults" style="max-height: 500px; overflow-y: auto;">
                            <p class="text-muted">Click a button above to load historical data.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div class="tab-pane fade" id="export">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-download"></i> Data Export
                    </div>
                    <div class="card-body">
                        <p>Export your detection data in multiple formats:</p>
                        <div class="mb-3">
                            <button class="export-btn" onclick="exportData('csv')">
                                <i class="fas fa-file-csv"></i> Download CSV
                            </button>
                            <button class="export-btn" onclick="exportData('json')">
                                <i class="fas fa-file-json"></i> Download JSON
                            </button>
                            <button class="export-btn" onclick="exportData('summary')">
                                <i class="fas fa-file-pdf"></i> Download Summary
                            </button>
                        </div>

                        <div class="alert-box">
                            <strong><i class="fas fa-info-circle"></i> Info:</strong>
                            Files are saved to the server's export directory and can be downloaded.
                        </div>

                        <div id="exportStatus"></div>
                    </div>
                </div>
            </div>

            <!-- Email Alerts Tab -->
            <div class="tab-pane fade" id="alerts">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-bell"></i> Email Alert Configuration
                    </div>
                    <div class="card-body">
                        <div class="email-config">
                            <h5><i class="fas fa-envelope"></i> Configure Email Alerts</h5>
                            <form id="emailForm">
                                <div class="mb-3">
                                    <label class="form-label">Sender Email</label>
                                    <input type="email" class="form-control" id="senderEmail" placeholder="your-email@gmail.com" autocomplete="email">
                                    <small class="text-muted">Gmail account to send alerts from</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email Password (App Password)</label>
                                    <input type="password" class="form-control" id="emailPassword" autocomplete="current-password">
                                    <small class="text-muted">Use Gmail App Password (not your regular password)</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Recipient Emails (comma-separated)</label>
                                    <textarea class="form-control" id="recipients" rows="3" placeholder="admin@example.com, manager@example.com"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Confidence Threshold for Alerts</label>
                                    <input type="range" class="form-range" id="alertThreshold" min="0" max="100" value="80">
                                    <small id="thresholdDisplay">Alert when confidence > 80%</small>
                                </div>

                                <button type="button" class="btn btn-primary" onclick="configureAlerts()">
                                    <i class="fas fa-cog"></i> Configure Alerts
                                </button>
                                <button type="button" class="btn btn-primary" onclick="testEmail()">
                                    <i class="fas fa-paper-plane"></i> Send Test Email
                                </button>
                            </form>
                        </div>

                        <div class="alert-box">
                            <strong><i class="fas fa-warning"></i> Security Note:</strong>
                            Your credentials are only used for sending emails and are not stored permanently. 
                            Use Gmail App Passwords for better security.
                        </div>

                        <div id="alertStatus"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p><i class="fas fa-satellite"></i> Satellite Fire Detection Dashboard v1.0</p>
        <p>Powered by NASA satellite imagery and advanced ML detection</p>
        <p style="font-size: 0.9rem; margin-top: 1rem;">¬© 2024 - All Rights Reserved</p>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>

    <script>
        // API Base URL
        const API_BASE = '/api';

        // Initialize map
        let map;
        let markers = [];

        function initMap() {
            map = L.map('map').setView([35.0, -110.0], 7);
            
            // Define different tile layers - using free, reliable providers
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                label: 'OpenStreetMap'
            });
            
            // Google Satellite (free, no key required)
            const googleSatellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '¬© Google',
                label: 'Google Satellite'
            });
            
            // USGS Satellite Imagery
            const usgsImagery = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 16,
                attribution: '¬© USGS',
                label: 'USGS Imagery'
            });
            
            const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap',
                maxZoom: 19,
                label: 'Topographic'
            });
            
            // Set Google Satellite as default
            googleSatellite.addTo(map);
            
            // Add layer control
            const baseLayers = {
                'Google Satellite': googleSatellite,
                'USGS Satellite': usgsImagery,
                'OpenStreetMap': osmLayer,
                'Topographic': topoLayer
            };
            
            L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);
        }

        function showMessage(msg, type = 'success') {
            const element = type === 'success' ? document.getElementById('successMsg') : document.getElementById('errorMsg');
            element.textContent = msg;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        }

        function updateMap(detections, lat, lon, radius) {
            console.log(`updateMap called with ${detections.length} detections`);
            
            // Clear old markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Add search radius circle
            L.circle([lat, lon], {
                radius: radius * 1000,  // Convert km to meters
                color: '#0066cc',
                weight: 2,
                opacity: 0.3,
                fillOpacity: 0.1
            }).addTo(map);

            // Add center marker - large and visible
            const centerMarker = L.circle([lat, lon], {
                radius: 5000,  // 5 km circle for visibility
                fillColor: '#0066cc',
                color: '#0066cc',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.3
            }).addTo(map);
            
            centerMarker.bindPopup('<strong>üéØ Search Center</strong><br>' + lat.toFixed(4) + ', ' + lon.toFixed(4));
            markers.push(centerMarker);

            // Add detection markers - LARGE and prominent
            if (detections && detections.length > 0) {
                detections.forEach((det, idx) => {
                    const confidence = det.confidence;
                    let color, label;
                    
                    if (confidence >= 0.9) {
                        color = '#ff0000';  // Red - High confidence
                        label = 'üî• HIGH';
                    } else if (confidence >= 0.7) {
                        color = '#ff8800';  // Orange - Medium confidence
                        label = '‚ö†Ô∏è MED';
                    } else {
                        color = '#ffff00';  // Yellow - Low confidence
                        label = '‚ö° LOW';
                    }
                    
                    // Large circle for visibility
                    const marker = L.circle([det.latitude, det.longitude], {
                        radius: 15000,  // 15 km circle = very visible
                        fillColor: color,
                        color: color,
                        weight: 4,
                        opacity: 1,
                        fillOpacity: 0.6
                    }).addTo(map);

                    // Detailed popup
                    marker.bindPopup(`
                        <div style="font-size: 14px;">
                            <strong>${label} Confidence Fire</strong><br>
                            üìç Lat: ${det.latitude.toFixed(4)}<br>
                            üìç Lon: ${det.longitude.toFixed(4)}<br>
                            üî• Confidence: ${(confidence * 100).toFixed(1)}%<br>
                            ‚ö° Thermal Power: ${det.power_mw?.toFixed(0) || 'N/A'} MW<br>
                            üìè Distance: ${det.distance_km?.toFixed(1) || 'N/A'} km
                        </div>
                    `);

                    marker.openPopup();  // Auto-open popup so it's visible
                    markers.push(marker);
                    console.log(`Added marker ${idx+1}: (${det.latitude}, ${det.longitude}) confidence: ${confidence}`);
                });
            } else {
                console.log('No detections to display');
                showMessage('No fires detected in this area', 'info');
            }

            // Set view - center on search location with appropriate zoom
            map.setView([lat, lon], 8);
            console.log(`Map centered on ${lat}, ${lon} with zoom 8`);
        }

        async function loadHistory(days = 1) {
            try {
                const response = await axios.get(`${API_BASE}/history?days=${days}`);
                displayHistory(response.data);
                showMessage('History loaded successfully!', 'success');
            } catch (error) {
                showMessage(`Error loading history: ${error.message}`, 'error');
            }
        }

        function displayHistory(data) {
            const results = document.getElementById('historyResults');
            const detections = data.detections || [];

            if (detections.length === 0) {
                results.innerHTML = '<p class="text-muted">No detections found in the selected period.</p>';
                return;
            }

            let html = `<p><strong>${detections.length} detections found</strong></p>`;
            html += '<table class="table table-sm"><thead class="table-light">';
            html += '<tr><th>Time</th><th>Location</th><th>Confidence</th><th>Power (MW)</th></tr></thead><tbody>';

            detections.slice(0, 50).forEach(det => {
                html += `
                    <tr>
                        <td>${new Date(det.detection_time).toLocaleString()}</td>
                        <td>${det.latitude?.toFixed(3)}, ${det.longitude?.toFixed(3)}</td>
                        <td><span class="badge" style="background: ${det.confidence >= 0.8 ? '#ff4444' : '#ffc107'};">${(det.confidence * 100).toFixed(0)}%</span></td>
                        <td>${det.power_mw?.toFixed(0) || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            results.innerHTML = html;
        }

        async function exportData(format) {
            try {
                const response = await axios.get(`${API_BASE}/export/${format}`);
                showMessage(`Data exported as ${format.toUpperCase()}!`, 'success');
            } catch (error) {
                showMessage(`Export error: ${error.message}`, 'error');
            }
        }

        async function configureAlerts() {
            const sender = document.getElementById('senderEmail').value;
            const password = document.getElementById('emailPassword').value;
            const recipients = document.getElementById('recipients').value.split(',').map(e => e.trim());

            if (!sender || !password || recipients.length === 0) {
                showMessage('Please fill all email fields', 'error');
                return;
            }

            try {
                await axios.post(`${API_BASE}/alerts/configure`, {
                    sender_email: sender,
                    sender_password: password,
                    recipients: recipients
                });
                showMessage('Email alerts configured successfully!', 'success');
            } catch (error) {
                showMessage(`Configuration error: ${error.message}`, 'error');
            }
        }

        async function testEmail() {
            try {
                await axios.post(`${API_BASE}/alerts/test`);
                showMessage('Test email sent! Check your inbox.', 'success');
            } catch (error) {
                showMessage(`Error sending test email: ${error.message}`, 'error');
            }
        }

        // Update slider displays
        document.getElementById('alertThreshold').addEventListener('input', (e) => {
            document.getElementById('thresholdDisplay').textContent = `Alert when confidence > ${e.target.value}%`;
        });

        // Auto-scan global fire hotspots
        async function autoScanGlobalFires() {
            // Global fire-prone regions to scan
            const globalHotspots = [
                { name: 'California, USA', lat: 37.7749, lon: -119.4179 },
                { name: 'Amazon, Brazil', lat: -3.4653, lon: -62.2159 },
                { name: 'Australia', lat: -25.2744, lon: 133.7751 },
                { name: 'Indonesia', lat: -0.7893, lon: 113.9213 },
                { name: 'Mediterranean', lat: 41.9028, lon: 12.4964 },
                { name: 'Siberia, Russia', lat: 61.5240, lon: 105.3188 },
                { name: 'Central Africa', lat: 1.6508, lon: 23.5993 },
                { name: 'India', lat: 20.5937, lon: 78.9629 },
                { name: 'Southeast Asia', lat: 13.7563, lon: 100.5018 },
                { name: 'Western Canada', lat: 53.7267, lon: -127.6476 }
            ];

            console.log('Starting global fire scan...');
            showMessage('Scanning global fire hotspots...', 'success');

            let allDetections = [];
            let hasRealData = false;
            
            // Scan each hotspot
            for (const hotspot of globalHotspots) {
                try {
                    const response = await axios.post(`${API_BASE}/detect/fires`, {
                        coordinates: [hotspot.lat, hotspot.lon],
                        radius_km: 200,
                        confidence_threshold: 0.5
                    });

                    // Check if we got real NASA FIRMS data
                    if (response.data.real_data === true) {
                        hasRealData = true;
                    }

                    if (response.data.detections && response.data.detections.length > 0) {
                        response.data.detections.forEach(det => {
                            det.region = hotspot.name;
                            allDetections.push(det);
                        });
                        console.log(`${hotspot.name}: Found ${response.data.detections.length} fires`);
                    }
                } catch (error) {
                    console.error(`Error scanning ${hotspot.name}:`, error);
                }
            }

            // Update data source label
            const dataSourceLabel = document.getElementById('dataSourceLabel');
            if (dataSourceLabel) {
                if (hasRealData) {
                    dataSourceLabel.innerHTML = '<span style="color: green;">‚úì NASA FIRMS (Real-time Satellite Data)</span>';
                } else {
                    dataSourceLabel.innerHTML = '<span style="color: orange;">‚ö†Ô∏è Demo Data (NASA FIRMS unavailable)</span>';
                }
            }

            // Display all detections on map
            if (allDetections.length > 0) {
                displayGlobalDetections(allDetections);
                showMessage(`Global scan complete! Found ${allDetections.length} fires worldwide`, 'success');
            } else {
                showMessage('Global scan complete - no active fires detected', 'info');
            }
        }

        function displayGlobalDetections(detections) {
            console.log(`Displaying ${detections.length} global fire detections`);
            
            // Clear old markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Add all fire markers
            detections.forEach((det, idx) => {
                const confidence = det.confidence;
                let color, label;
                
                if (confidence >= 0.9) {
                    color = '#ff0000';
                    label = 'üî•';
                } else if (confidence >= 0.7) {
                    color = '#ff8800';
                    label = '‚ö†Ô∏è';
                } else {
                    color = '#ffcc00';
                    label = '‚ö°';
                }
                
                // Large visible circle
                const marker = L.circle([det.latitude, det.longitude], {
                    radius: 50000,  // 50 km radius
                    fillColor: color,
                    color: color,
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.4
                }).addTo(map);

                marker.bindPopup(`
                    <div style="font-size: 13px;">
                        <strong>${label} ${det.region || 'Fire Detection'}</strong><br>
                        üìç ${det.latitude.toFixed(3)}¬∞, ${det.longitude.toFixed(3)}¬∞<br>
                        üî• Confidence: ${(confidence * 100).toFixed(0)}%<br>
                        ‚ö° Power: ${det.power_mw?.toFixed(0) || 'N/A'} MW
                    </div>
                `);

                markers.push(marker);
            });

            // Set global view
            map.setView([20, 0], 2);
            console.log('Map set to global view');
            
            // Update stats
            loadStats();
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initMap();
            // Load initial stats
            loadStats();
            // Auto-scan global fire hotspots
            autoScanGlobalFires();
        });

        async function loadStats() {
            try {
                const response = await axios.get(`${API_BASE}/stats`);
                const stats = response.data;
                document.getElementById('totalFires').textContent = stats.total_detections || '0';
                document.getElementById('avgConfidence').textContent = (stats.average_confidence * 100).toFixed(0) + '%' || '0%';
                document.getElementById('alertsSent').textContent = stats.alerts_sent || '0';
                document.getElementById('totalPower').textContent = (stats.total_thermal_power_mw || 0).toFixed(0) + ' MW';
            } catch (error) {
                console.log('Could not load stats');
            }
        }
    </script>
</body>
</html>
